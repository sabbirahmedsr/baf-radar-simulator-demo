<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BAF RADAR SIMULATOR</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/simulator.css">
  <link rel="stylesheet" href="css/diorama.css">
  <link rel="stylesheet" href="css/resource.css">
</head>
<body>
  <header id="main-header">
    <h1>BAF RADAR SIMULATOR</h1>
    <nav>
      <a href="#simulator" class="nav-link active" data-view="simulator-view">Simulator</a>
      <a href="#diorama" class="nav-link" data-view="diorama-view">Airport Diorama</a>
      <a href="#resource" class="nav-link" data-view="resource-view">Resources</a>
    </nav>
  </header>

  <main>
    <div id="simulator-view" class="view active">
      <div id="top">
        <canvas id="altitudeGraphVerticalCanvas" width="120" height="800"></canvas>
        <div id="radarContainer">
          <canvas id="radarCanvas" width="800" height="800"></canvas>
        </div>
        <div id="sidePanel">
          <h3>Selected Target</h3>
          <div id="dataPanel" class="dataBlock">No selection</div>
          <div id="guiCommandPanel">
            <h4>Issue Command</h4>
            <div class="gui-command-row">
              <label for="guiCmdHeading">Heading (0-359)</label>
              <div class="input-group">
                <input type="number" id="guiCmdHeading" placeholder="e.g., 270">
                <button id="guiSendHeading">Set</button>
              </div>
            </div>
            <div class="gui-command-row">
              <label for="guiCmdAltitude">Altitude (ft)</label>
              <div class="input-group">
                <input type="number" id="guiCmdAltitude" placeholder="e.g., 9000" step="1000">
                <button id="guiSendAltitude">Set</button>
              </div>
            </div>
            <div class="gui-command-row">
              <label for="guiCmdSpeed">Speed (kts)</label>
              <div class="input-group">
                <input type="number" id="guiCmdSpeed" placeholder="e.g., 250">
                <button id="guiSendSpeed">Set</button>
              </div>
            </div>
            <div class="gui-command-row">
              <button id="guiSendHold">Engage Hold</button>
            </div>
          </div>
          <h3 class="collapsible-header active">Controls</h3>
          <div class="collapsible-content">
            <div class="control-group">
              <h4>Aircraft</h4>
              <button id="addAircraftBtn">Add Aircraft</button>
              <button id="addVGHSAircraftBtn">Add Hypersonic</button>
              <button id="removeAircraftBtn">Remove Sel.</button>
            </div>
            <div class="control-group">
              <h4>Display & Radar</h4>
              <label>Range (km): <input id="radarRangeInput" type="number" value="100" min="50" max="500"></label>
              <label><input id="toggleID" type="checkbox" checked> Show ID</label>
              <label><input id="toggleSpeed" type="checkbox" checked> Show Speed</label>
              <label><input id="toggleAltitude" type="checkbox" checked> Show Altitude</label>
              <label><input id="toggleHeading" type="checkbox" checked> Show Heading</label>
              <label><input id="toggleTrails" type="checkbox" checked> Show Trails</label>
            </div>
          </div>
          <h3 class="collapsible-header">Command Help</h3>
          <div class="collapsible-content">
            <div class="control-group">
              <p class="help-desc">Commands are in the format: <br><span class="help-command">&lt;Callsign&gt; &lt;Verb&gt; &lt;Param&gt;</span></p>
              <p><span class="help-command">C &lt;heading&gt;</span><br><span class="help-desc">Clearance to a 3-digit heading. Ex: <span class="help-command">C 090</span></span></p>
              <p><span class="help-command">C &lt;altitude&gt;</span><br><span class="help-desc">Clearance to an altitude (x1000 ft). Ex: <span class="help-command">C 12</span> (for 12,000 ft)</span></p>
              <p><span class="help-command">S &lt;speed&gt;</span><br><span class="help-desc">Set speed in knots. Ex: <span class="help-command">S 250</span></span></p>
              <p><span class="help-command">H</span><br><span class="help-desc">Hold current position.</span></p>
              <hr>
              <p class="help-desc">Commands can be chained:</p>
              <p><span class="help-command">AC101 C 270 C 8 S 210</span></p>
            </div>
          </div>
          <h3>Command Line</h3>
          <div id="cmdLine">
            <input id="cmdInput" placeholder="e.g. AC101 C 090 C 15 S 300" />
            <button id="cmdSend">Send</button>
          </div>
          <h3>Metrics</h3>
          <div id="metricsPanel" class="dataBlock">
            <div>Near-misses: <span id="metricNearMiss">0</span></div>
            <div>Conflicts resolved: <span id="metricResolved">0</span></div>
            <div>Commands issued: <span id="metricCommands">0</span></div>
          </div>
          <h3>Log</h3>
          <div id="logPanel"></div>
          <h3>Aircraft List</h3>
          <div id="aircraftList"></div>
        </div>
      </div>
    </div>

    <div id="diorama-view" class="view"></div>
    <div id="resource-view" class="view"></div>
  </main>

  <!-- Modal Structure -->
  <div id="resource-modal" class="modal-container">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <img id="modal-img" src="" alt="Modal Image">
      <div class="modal-header">
        <h2 id="modal-title"></h2>
        <a id="modal-external-link" href="#" target="_blank" class="modal-button">Open Source</a>
      </div>
      <p id="modal-description"></p>
    </div>
  </div>


  <script type="module" src="js/main.js"></script>
  <script type="module">
    import { Diorama } from './js/ui/diorama.js';

    // Simple SPA router
    document.addEventListener('DOMContentLoaded', () => {
      const navLinks = document.querySelectorAll('.nav-link');
      const views = document.querySelectorAll('.view');

      const loadView = async (viewId) => {
        const viewElement = document.getElementById(viewId);
        // Only fetch content if the view is empty
        if (viewElement && viewElement.innerHTML.trim() === '') {
          try {
            if (viewId === 'resource-view') {
              await loadResourceView(viewElement);
            } else {
              const response = await fetch(`view/${viewId}.html`);
              if (!response.ok) throw new Error(`Could not load ${viewId}.html`);
              const content = await response.text();
              viewElement.innerHTML = content;

              if (viewId === 'diorama-view') {
                setupDioramaInteractiveDemo();
                setupConceptGalleryListeners();
              }
            }
          } catch (error) {
            console.error('Failed to load view:', error);
            viewElement.innerHTML = `<p style="color: red;">Error loading content.</p>`;
          }
        }
      };

      const setupDioramaInteractiveDemo = () => {
        // This function is now just a simple initializer.
        const canvas = document.getElementById('diorama-canvas');
        const slider = document.getElementById('diorama-slider');
        const scenarioRadios = document.querySelectorAll('input[name="scenario"]');
        new Diorama(canvas, slider, scenarioRadios);
      };

      const setupConceptGalleryListeners = () => {
        document.querySelectorAll('[data-enlargeable]').forEach(item => {
          item.addEventListener('click', () => {
            const modal = document.getElementById('resource-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Populate modal for image-only view
            document.getElementById('modal-img').src = item.src;
            
            // Add a class to hide text elements
            modalContent.classList.add('image-only');
            
            // Show modal
            modal.style.display = 'flex';
          });
        });
      };

      const loadResourceView = async (viewElement) => {
        const response = await fetch('data/resource.md');
        if (!response.ok) throw new Error('Could not load data/resource.md');
        const mdContent = await response.text();

        const resources = mdContent.split(/\r?\n---\r?\n/).map(block => {
          if (block.trim() === '') return null;
          const imageMatch = block.match(/!\[.*?\]\((.*?)\)/);
          const titleMatch = block.match(/### (.*?)\s*?\n/);
          const urlMatch = block.match(/#### (.*?)\s*?\n/);
          const shortMatch = block.match(/###### (.*?)\s*?\n/);
          // The long description is the text that follows the last metadata header (######).
          const longMatch = block.match(/###### .*?\s*?\n\n*([\s\S]+)/);
          return {
            image: imageMatch ? imageMatch[1] : '',
            title: titleMatch ? titleMatch[1] : 'No Title',
            url: urlMatch ? urlMatch[1].trim() : '#',
            short: shortMatch ? shortMatch[1].trim() : '',
            long: longMatch ? longMatch[1].trim() : ''
          };
        }).filter(Boolean);

        const gridHtml = resources.map(res => `
          <div class="resource-item" 
               data-modal-image="${res.image}"
               data-modal-title="${res.title}"
               data-external-url="${res.url}"
               data-modal-description="${res.long.replace(/"/g, '&quot;')}">
            <div class="resource-image-container">
              <img src="${res.image}" alt="${res.title}">
            </div>
            <div class="resource-content">
              <h3>${res.title}</h3>
              <p>${res.short}</p>
            </div>
          </div>
        `).join('');

        viewElement.innerHTML = `
          <div class="resource-container">
            <h2>Resources & Inspiration</h2>
            <p>A collection of assets, concepts, and technologies that inspire and inform this project. Click on any card for more details.</p>
            <div class="resource-grid">${gridHtml}</div>
          </div>
        `;
        setupModalListeners();
      };

      navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetViewId = link.getAttribute('data-view');

          loadView(targetViewId).then(() => {
            views.forEach(view => view.classList.remove('active'));
            navLinks.forEach(navLink => navLink.classList.remove('active'));
            link.classList.add('active');
            document.getElementById(targetViewId).classList.add('active');
            window.history.pushState({}, '', link.href);
          });
        });
      });

      // Pre-load the active view if it's not the simulator
      const activeLink = document.querySelector('.nav-link.active');
      if (activeLink) {
        const activeViewId = activeLink.getAttribute('data-view');
        if (activeViewId !== 'simulator-view') {
          loadView(activeViewId);
        }
      }

      // --- Modal Logic ---
      const modal = document.getElementById('resource-modal');
      const modalClose = document.querySelector('.modal-close');

      function setupModalListeners() {
        document.querySelectorAll('.resource-item').forEach(item => {
          item.addEventListener('click', () => {
            // Populate modal
            document.getElementById('modal-img').src = item.dataset.modalImage;
            document.getElementById('modal-title').textContent = item.dataset.modalTitle;
            document.getElementById('modal-description').textContent = item.dataset.modalDescription;
            document.getElementById('modal-external-link').href = item.dataset.externalUrl;
            
            // Ensure modal is not in image-only mode
            modal.querySelector('.modal-content').classList.remove('image-only');

            // Show modal
            modal.style.display = 'flex';
          });
        });
      }

      function closeModal() {
        modal.style.display = 'none';
      }

      modalClose.addEventListener('click', closeModal);

      window.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });

    });
  </script>
</body>
</html>
